<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>ERP Estamparia</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div id="app" class="app">
    <!-- ========= SIDEBAR ========= -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">BT</div>
        <div class="brand-name">Estamparia ERP</div>

        <!-- Toggle â€œhambÃºrguerâ€ (desktop: colapsa; mobile: abre overlay) -->
        <button id="sidebar-toggle" class="toggle-btn" title="Menu">
          <span class="icon">â‰¡</span>
        </button>

        <!-- BotÃ£o X (visÃ­vel sÃ³ quando overlay mobile estiver aberto) -->
        <button id="sidebar-close" class="mobile-close" aria-label="Fechar menu">Ã—</button>
      </div>

      <nav class="nav">
        <div class="nav-top">
          <!-- Cadastrar -->
          <div class="nav-item" data-submenu="sub-cad">
            <span class="icon">ï¼‹</span>
            <span class="label">Cadastrar</span>
            <span class="caret">â–¾</span>
          </div>
          <div id="sub-cad" class="submenu">
            <a class="submenu-link" data-menu="cad:produtos"   href="#/cadastro/produtos"><span class="icon">ğŸ“¦</span> Produtos</a>
            <a class="submenu-link" data-menu="cad:clientes"   href="#/cadastro/clientes"><span class="icon">ğŸ‘¤</span> Clientes</a>
            <a class="submenu-link" data-menu="cad:servicos"   href="#/cadastro/servicos"><span class="icon">ğŸ› ï¸</span> ServiÃ§os</a>
            <a class="submenu-link" data-menu="cad:ent:prod"   href="#/cadastro/entradas/produtos"><span class="icon">ğŸ“¥</span> Entrada (Produtos)</a>
            <a class="submenu-link" data-menu="cad:ent:serv"   href="#/cadastro/entradas/servicos"><span class="icon">ğŸ“¥</span> Entrada (ServiÃ§os)</a>
            <a class="submenu-link" data-menu="cad:sai:prod"   href="#/cadastro/saidas/produtos"><span class="icon">ğŸ“¤</span> SaÃ­da (Produtos)</a>
            <a class="submenu-link" data-menu="cad:sai:serv"   href="#/cadastro/saidas/servicos"><span class="icon">ğŸ“¤</span> SaÃ­da (ServiÃ§os)</a>
          </div>

          <!-- Consultar -->
          <div class="nav-item" data-submenu="sub-cons">
            <span class="icon">â˜</span>
            <span class="label">Consultar</span>
            <span class="caret">â–¾</span>
          </div>
          <div id="sub-cons" class="submenu">
            <a class="submenu-link" data-menu="con:produtos"   href="#/consulta/produtos"><span class="icon">ğŸ“¦</span> Produtos</a>
            <a class="submenu-link" data-menu="con:clientes"   href="#/consulta/clientes"><span class="icon">ğŸ‘¤</span> Clientes</a>
            <a class="submenu-link" data-menu="con:servicos"   href="#/consulta/servicos"><span class="icon">ğŸ› ï¸</span> ServiÃ§os</a>
            <a class="submenu-link" data-menu="con:entradas"   href="#/consulta/entradas"><span class="icon">ğŸ“¥</span> Entradas</a>
            <a class="submenu-link" data-menu="con:saidas"     href="#/consulta/saidas"><span class="icon">ğŸ“¤</span> SaÃ­das</a>
          </div>

          <!-- RelatÃ³rios -->
          <div class="nav-item" data-submenu="sub-rep">
            <span class="icon">ğŸ“Š</span>
            <span class="label">RelatÃ³rios</span>
            <span class="caret">â–¾</span>
          </div>
          <div id="sub-rep" class="submenu">
            <a class="submenu-link" data-menu="rel:faturamento"       href="#/relatorios/faturamento"><span class="icon">ğŸ’µ</span> Faturamento</a>
            <a class="submenu-link" data-menu="rel:fat-por-cliente"   href="#/relatorios/fat-por-cliente"><span class="icon">ğŸ‘¥</span> Faturamento por Cliente</a>
            <a class="submenu-link" data-menu="rel:historico"         href="#/relatorios/historico-comercial"><span class="icon">ğŸ—‚ï¸</span> HistÃ³rico Comercial</a>
          </div>

          <a class="nav-item" data-menu="dash" href="#/">
            <span class="icon">ğŸ </span>
            <span class="label">Dashboard</span>
          </a>
        </div>

        <div class="nav-bottom">
          <a class="nav-item" data-menu="cfg" href="#/configuracoes">
            <span class="icon">âš™ï¸</span>
            <span class="label">ConfiguraÃ§Ãµes</span>
          </a>
          <a class="nav-item" data-menu="perfil" href="#/perfil">
            <span class="icon">ğŸ‘¤</span>
            <span class="label">Perfil</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- ===== Painel lateral de submenus (novo) ===== -->
    <aside class="subpanel" id="subpanel">
      <div class="subhead">
        <span id="subpanel-title">Menu</span>
        <button class="subclose" id="subpanel-close" title="Fechar">Ã—</button>
      </div>
      <div class="slist" id="subpanel-body"></div>
    </aside>

    <!-- Backdrop (fecha overlay no mobile) -->
    <div id="sidebar-backdrop" class="backdrop" aria-hidden="true"></div>

    <!-- FAB (botÃ£o flutuante â€“ abre overlay no mobile) -->
    <button id="menu-fab" class="menu-fab" title="Abrir menu">â˜°</button>

    <!-- ========= CONTEÃšDO ========= -->
    <main class="content">
      <header class="topbar">
        <h1 id="page-title">Dashboard</h1>
        <div class="userbar">
          <div class="avatar">O</div>
          <div class="name">Operador</div>
          <a href="#/perfil">Perfil</a>
        </div>
      </header>

      <section id="view-root" class="view-root">
        <!-- ConteÃºdo injetado pelas views -->
      </section>

      <footer class="footerbar">
        <span id="footer-date"></span>
        <span>v37.4.0</span>
      </footer>
    </main>
  </div>

  <!-- ========= SCRIPTS ========= -->
  <!-- Shared / helpers -->
  <script src="shared/types.js"></script>
  <script src="charts.js"></script>

  <!-- UI Prefs (precisa estar antes das views e do router) -->
  <script src="ui-prefs.js"></script>

  <!-- Views: cadastro -->
  <script src="views/cadastro-clientes.js"></script>
  <script src="views/cadastro-produtos.js"></script>
  <script src="views/cadastro-servicos.js"></script>
  <script src="views/cadastro-entrada-prod.js"></script>
  <script src="views/cadastro-entrada-serv.js"></script>
  <script src="views/cadastro-saida-prod.js"></script>
  <script src="views/cadastro-saida-serv.js"></script>

  <!-- Views: consultas -->
  <script src="views/consulta-clientes.js"></script>
  <script src="views/consulta-produtos.js"></script>
  <script src="views/consulta-servicos.js"></script>
  <script src="views/consultar-entradas.js"></script>
  <script src="views/consultar-saidas.js"></script>

  <!-- Views: relatÃ³rios -->
  <script src="views/rel-faturamento.js"></script>
  <script src="views/rel-fat-por-cliente.js"></script>
  <script src="views/rel-historico-comercial.js"></script>

  <!-- Outras views -->
  <script src="views/configuracoes.js"></script>
  <script src="views/perfil.js"></script>
  <script src="views/dashboard.js"></script>
  <script src="views/lookup-modal.js"></script>

  <!-- Router -->
  <script src="router.js"></script>

  <!-- ===== Submenus: painel lateral no desktop / inline no mobile ===== -->
  <script>
    // elementos do painel
    const appEl      = document.getElementById('app');
    const subpanel   = document.getElementById('subpanel');
    const spTitle    = document.getElementById('subpanel-title');
    const spBody     = document.getElementById('subpanel-body');
    const spCloseBtn = document.getElementById('subpanel-close');
    const sidebarEl  = document.getElementById('sidebar');

    const isMobile = () => window.innerWidth <= 980;

    function closeSubpanel(){
      appEl.classList.remove('subopen');
      spBody.innerHTML = '';
      document.querySelectorAll('.nav-item.active').forEach(n => n.classList.remove('active'));
    }

    function openSubpanel(triggerEl, templateEl){
      if (!templateEl) return;
      // tÃ­tulo a partir do rÃ³tulo do botÃ£o
      const t = triggerEl.querySelector('.label')?.textContent?.trim() || 'Menu';
      spTitle.textContent = t;

      // clona os links do template
      spBody.innerHTML = '';
      templateEl.querySelectorAll('a').forEach(a => {
        const clone = a.cloneNode(true);
        clone.addEventListener('click', () => closeSubpanel());
        spBody.appendChild(clone);
      });

      // marca ativo e exibe painel
      document.querySelectorAll('.nav-item.active').forEach(n => n.classList.remove('active'));
      triggerEl.classList.add('active');
      appEl.classList.add('subopen');
    }

    // Clique nos itens de topo
    document.addEventListener('click', (ev) => {
      const trigger = ev.target.closest('.nav-item[data-submenu]');
      if (!trigger) return;

      const id = trigger.getAttribute('data-submenu');
      const tpl = document.getElementById(id);
      if (!tpl) return;

      // Mobile: mantÃ©m comportamento inline (abre dentro da prÃ³pria sidebar)
      if (isMobile()){
        tpl.classList.toggle('open');
        return;
      }

      // Desktop: painel lateral
      const already = trigger.classList.contains('active') && appEl.classList.contains('subopen');
      if (already) { closeSubpanel(); return; }
      openSubpanel(trigger, tpl);
    });

    // Fechamentos
    spCloseBtn?.addEventListener('click', closeSubpanel);
    document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closeSubpanel(); });

    // Fechar ao clicar fora
    document.addEventListener('click', (ev) => {
      if (!appEl.classList.contains('subopen')) return;
      const insideSidebar = sidebarEl.contains(ev.target);
      const insidePanel   = subpanel.contains(ev.target);
      if (!insideSidebar && !insidePanel) closeSubpanel();
    });
  </script>

  <!-- ===== Controle do overlay mobile (sem alterar desktop) ===== -->
  <script>
    (function () {
      const app       = document.querySelector('.app');
      const toggleBtn = document.getElementById('sidebar-toggle');
      const closeBtn  = document.getElementById('sidebar-close');
      const backdrop  = document.getElementById('sidebar-backdrop');
      const fab       = document.getElementById('menu-fab');
      const sidebar   = document.querySelector('.sidebar');

      const isMobile = () => window.innerWidth <= 980;

      function openOverlay(){
        // ao abrir overlay, garantimos que o painel lateral esteja fechado
        app.classList.remove('subopen');
        app.classList.add('mobile-open');
        fab.classList.add('hide');
      }
      function closeOverlay(){
        app.classList.remove('mobile-open');
        fab.classList.remove('hide');
      }

      // HambÃºrguer: desktop = colapsa; mobile = overlay
      toggleBtn?.addEventListener('click', (e) => {
        if (isMobile()) {
          e.preventDefault();
          app.classList.contains('mobile-open') ? closeOverlay() : openOverlay();
        } else {
          app.classList.toggle('collapsed');
        }
      });

      closeBtn?.addEventListener('click', closeOverlay);
      backdrop?.addEventListener('click', closeOverlay);
      fab?.addEventListener('click', openOverlay);

      // Fechar overlay ao clicar em qualquer link/botÃ£o do menu (mobile)
      sidebar?.addEventListener('click', (ev) => {
        const hit = ev.target.closest('a,button');
        if (!hit) return;
        if (isMobile()) closeOverlay();
      });

      // Ao redimensionar, garantir estados coerentes
      window.addEventListener('resize', () => {
        if (!isMobile()) {
          app.classList.remove('mobile-open');
          fab?.classList.add('hide');
        } else if (!app.classList.contains('mobile-open')) {
          fab?.classList.remove('hide');
        }
      });

      // Estado inicial do FAB
      if (!isMobile()) fab?.classList.add('hide');

      // RodapÃ© com data (mantido)
      (function () {
        const el = document.getElementById('footer-date');
        const d = new Date();
        const f = d.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', weekday:'long' });
        if (el) el.textContent = f;
      })();
    })();
  </script>
</body>
</html>
